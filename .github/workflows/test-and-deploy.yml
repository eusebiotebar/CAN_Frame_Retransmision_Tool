name: Test and Deploy

on:
  push:
    branches: [ main ]
  pull_request:
    branches: [ main ]

jobs:
  build-test:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - uses: actions/setup-python@v5
        with:
          # Pin patch version to avoid Black warning on vulnerable 3.12.5
          python-version: '3.12.6'
      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install -e .[dev]
          
      - name: Run comprehensive tests
        run: |
          chmod +x scripts/test.sh
          scripts/test.sh --all --coverage
          
      - name: Upload coverage reports to Codecov
        uses: codecov/codecov-action@v4
        with:
          file: ./coverage.xml
          flags: unittests
          name: codecov-umbrella
          fail_ci_if_error: false
          
      - name: Upload coverage to GitHub
        uses: actions/upload-artifact@v4
        with:
          name: coverage-report
          path: htmlcov/
          
      - name: Comment coverage on PR
        if: github.event_name == 'pull_request'
        uses: py-cov-action/python-coverage-comment-action@v3
        with:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          
      - name: Lint
        run: |
          ruff check .
          # Run Black; if it fails, show the diff for easier diagnosis
          black --check . || (echo 'Black formatting differences:' && black --diff . && exit 1)
          mypy core || true
      - name: Build artifact
        run: |
          pip install build
          python -m build
          
      - name: Upload Python packages
        uses: actions/upload-artifact@v4
        with:
          name: python-dist
          path: dist/*
          
  build-windows-exe:
    runs-on: windows-latest
    needs: build-test
    if: github.ref == 'refs/heads/main'
    steps:
      - uses: actions/checkout@v4
      - uses: actions/setup-python@v5
        with:
          python-version: '3.12.6'
      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install -e .[dev]
          pip install pyinstaller
      - name: Build Windows executable
        run: |
          scripts/build.ps1 -Executable
      - name: Test executable
        run: |
          if (Test-Path "dist/can-id-reframe.exe") {
            Write-Host "âœ… Executable built successfully"
            # Test executable with CLI help (doesn't start GUI)
            $exitCode = 0
            try {
              & "dist/can-id-reframe.exe" --help-cli
              $exitCode = $LASTEXITCODE
            } catch {
              $exitCode = 1
            }
            if ($exitCode -eq 0) {
              Write-Host "âœ… Executable basic test passed"
            } else {
              Write-Error "âŒ Executable test failed with exit code $exitCode"
            }
          } else {
            Write-Error "âŒ Executable not found"
          }
      - name: Upload Windows executable
        uses: actions/upload-artifact@v4
        with:
          name: windows-executable
          path: dist/can-id-reframe.exe

  deploy-staging:
    needs: [build-test, build-windows-exe]
    runs-on: ubuntu-latest
    if: github.ref == 'refs/heads/main'
    steps:
      - uses: actions/checkout@v4
      - name: Download Python artifacts
        uses: actions/download-artifact@v4
        with:
          name: python-dist
          path: dist/
      - name: Download Windows executable
        uses: actions/download-artifact@v4
        with:
          name: windows-executable
          path: dist/
      - name: List artifacts
        run: |
          echo "ðŸ“¦ Built artifacts:"
          ls -la dist/
      - name: Deploy to staging (placeholder)
        run: |
          echo "ðŸš€ Ready for staging deployment"
          echo "Python packages: $(ls dist/*.whl dist/*.tar.gz 2>/dev/null | wc -l)"
          echo "Windows executable: $(ls dist/*.exe 2>/dev/null | wc -l)"

  deploy-production:
    needs: deploy-staging
    runs-on: ubuntu-latest
    if: startsWith(github.ref, 'refs/tags/v')
    steps:
      - uses: actions/checkout@v4
      - name: Deploy to production (placeholder)
        run: echo "ðŸŽ¯ Production deployment triggered by tag"
